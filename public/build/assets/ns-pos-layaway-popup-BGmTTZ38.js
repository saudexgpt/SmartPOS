import{k as F}from"./print-DOU-TAfv.js";import{b as u,a as T}from"./bootstrap-DN_KIGH5.js";import{_ as l,n as V}from"./currency-gBUix5n2.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{r as _,o as c,c as h,b as s,t as i,g as f,f as g,F as k,e as C,h as I,w as b,j as v}from"./runtime-core.esm-bundler-DDZT2pc5.js";import"./chart-Ozef1QaY.js";const O={name:"ns-pos-layaway-popup",props:["popup"],data(){return{fields:[],instalments:[],formValidation:new F,subscription:null,totalPayments:0}},mounted(){this.loadFields()},updated(){setTimeout(()=>{document.querySelector(".is-popup #total_instalments").addEventListener("change",()=>{const t=this.formValidation.extractFields(this.fields).total_instalments;this.generatePaymentFields(t)}),document.querySelector(".is-popup #total_instalments").addEventListener("focus",()=>{document.querySelector(".is-popup #total_instalments").select()})},200)},computed:{expectedPayment(){const t=this.order.customer.group.minimal_credit_payment;return nsRawCurrency(this.order.total*t/100)},order(){return this.popup.params.order.instalments=this.popup.params.order.instalments.map(t=>{for(let e in t)if(typeof t[e]!="object"){if(e==="date"){const r={type:"date",name:e,label:l("Date"),disabled:t.paid===1,value:moment(t.date).format("YYYY-MM-DD")};t[e]=r}else if(e==="amount"){const r={type:"number",name:e,label:l("Amount"),disabled:t.paid===1,value:t.amount};t[e]=r}else if(!["paid","id"].includes(e)){const r={type:"hidden",name:e,value:t[e]};t[e]=r}}return t}),this.popup.params.order}},unmounted(){},methods:{__:l,nsCurrency:V,refreshTotalPayments(){if(this.order.instalments.length>0){const t=nsRawCurrency(this.order.instalments.map(e=>parseFloat(e.amount.value)||0).reduce((e,r)=>parseFloat(e)+parseFloat(r)));this.totalPayments=this.order.total-t}else this.totalPayments=0},removeInstalment(t){const e=this.order.instalments.indexOf(t);this.order.instalments.splice(e,1),this.$forceUpdate()},generatePaymentFields(t){this.order.instalments=new Array(parseInt(t)).fill("").map((e,r)=>({date:{type:"date",name:"date",label:"Date",value:r===0?ns.date.moment.format("YYYY-MM-DD"):""},amount:{type:"number",name:"amount",label:"Amount",value:r===0?this.expectedPayment:0},readonly:{type:"hidden",name:"readonly",value:this.expectedPayment>0&&r===0}})),this.$forceUpdate(),this.refreshTotalPayments()},close(){this.popup.params.reject({status:"error",message:l("You must define layaway settings before proceeding.")}),this.popup.close()},skipInstalments(){this.expectedPayment>0?(this.order.instalments=[{amount:this.expectedPayment,date:ns.date.current}],this.order.final_payment_date=this.order.instalments.reverse()[0].date,this.order.total_instalments=this.order.instalments.length,this.order.support_instalments=!1):(this.order.final_payment_date=ns.date.current,this.order.total_instalments=0,this.order.support_instalments=!1),this.popup.close(),POS.order.next(this.order);const{resolve:t,reject:e}=this.popup.params;return t({order:this.order,skip_layaway:!0})},updateOrder(){if(this.order.instalments.length===0)return u.error(l("Please provide instalments before proceeding.")).subscribe();if(this.fields.forEach(n=>this.formValidation.validateField(n)),!this.formValidation.fieldsValid(this.fields))return u.error(l("Unable to process, the form is not valid")).subscribe();this.$forceUpdate();const t=this.order.instalments.map(n=>({amount:parseFloat(n.amount.value),date:n.date.value})),e=nsRawCurrency(t.map(n=>n.amount).reduce((n,m)=>parseFloat(n)+parseFloat(m)));if(t.filter(n=>n.date===void 0||n.date==="").length>0)return u.error(l("One or more instalments has an invalid date.")).subscribe();if(t.filter(n=>!(n.amount>0)).length>0)return u.error(l("One or more instalments has an invalid amount.")).subscribe();if(t.filter(n=>moment(n.date).isBefore(ns.date.moment.startOf("day"))).length>0)return u.error(l("One or more instalments has a date prior to the current date.")).subscribe();const r=t.filter(n=>moment(n.date).isSame(ns.date.moment.startOf("day"),"day"));let y=0;if(r.forEach(n=>{y+=parseFloat(n.amount)}),y<this.expectedPayment)return u.error(l("The payment to be made today is less than what is expected.")).subscribe();if(e<nsRawCurrency(this.order.total))return u.error(l("Total instalments must be equal to the order total.")).subscribe();t.sort((n,m)=>{const o=moment(n.date),p=moment(m.date);return o.isBefore(p)?-1:o.isAfter(p)?1:0});const d=this.formValidation.extractFields(this.fields);d.final_payment_date=t.reverse()[0].date,d.total_instalments=t.length;const a={...this.popup.params.order,...d,instalments:t},{resolve:x,reject:w}=this.popup.params;return this.popup.close(),POS.order.next(a),x({order:a,skip_layaway:!1})},loadFields(){T.get("/api/fields/ns.layaway").subscribe(t=>{this.fields=this.formValidation.createFields(t),this.fields.forEach(e=>{e.name==="total_instalments"&&(e.value=this.order.total_instalments||0)})})}}},S={class:"shadow-lg h-95vh md:h-5/6-screen lg:h-5/6-screen w-95vw md:w-4/6-screen lg:w-3/6-screen ns-box flex flex-col"},Y={class:"p-2 border-b ns-box-header flex justify-between items-center"},B={class:"font-semibold"},D={class:"p-2 flex-auto flex flex-col relative overflow-y-auto"},M={key:0,class:"absolute h-full w-full flex items-center justify-center"},E={class:"p-2 elevation-surface info mb-2 text-center text-2xl font-bold flex justify-between"},L={class:"flex flex-col flex-auto overflow-hidden"},q={class:"border-b ns-box-body"},A={class:"text-2xl flex justify-between py-2 text-primary"},N={class:"text-sm"},R={class:"p-2 mb-2 text-center bg-green-200 text-green-700"},U={class:"flex-auto overflow-y-auto"},H={class:"flex flex-auto"},z={class:"px-1 w-full md:w-1/2"},G={class:"px-1 w-full md:w-1/2"},J={class:"flex items-center"},K=["onClick"],Q={key:0,class:"my-2"},W={class:"p-2 elevation-surface border text-primary text-center"},X={class:"p-2 flex border-t ns-box-footer justify-between flex-shrink-0"},Z={class:"md:-mx-1 flex flex-col md:flex-row"},$={class:"md:px-1"},ee={class:"md:-mx-1 flex flex-col md:flex-row"},te={class:"md:px-1"},se={class:"md:px-1"};function ne(t,e,r,y,d,a){const x=_("ns-close-button"),w=_("ns-spinner"),n=_("ns-field"),m=_("ns-button");return c(),h("div",S,[s("div",Y,[s("h3",B,i(a.__("Layaway Parameters")),1),s("div",null,[f(x,{onClick:e[0]||(e[0]=o=>a.close())})])]),s("div",D,[d.fields.length===0?(c(),h("div",M,[f(w)])):g("",!0),s("div",E,[s("span",null,i(a.__("Minimum Payment")),1),s("span",null,i(a.nsCurrency(a.expectedPayment)),1)]),s("div",null,[(c(!0),h(k,null,C(d.fields,(o,p)=>(c(),I(n,{field:o,key:p},null,8,["field"]))),128))]),s("div",L,[s("div",q,[s("h3",A,[s("span",null,i(a.__("Instalments & Payments")),1),s("p",null,[s("span",N,"("+i(a.nsCurrency(d.totalPayments))+")",1),s("span",null,i(a.nsCurrency(t.total)),1)])]),s("p",R,i(a.__("The final payment date must be the last within the instalments.")),1)]),s("div",U,[(c(!0),h(k,null,C(a.order.instalments,(o,p)=>(c(),h("div",{class:"flex w-full -mx-1 py-2",key:p},[s("div",H,[s("div",z,[f(n,{onChange:e[1]||(e[1]=P=>a.refreshTotalPayments()),field:o.date},null,8,["field"])]),s("div",G,[f(n,{onChange:e[2]||(e[2]=P=>a.refreshTotalPayments()),field:o.amount},null,8,["field"])])]),s("div",J,[s("button",{onClick:P=>a.removeInstalment(o),class:"items-center flex justify-center h-8 w-8 rounded border text-primary ns-inset-button error"},e[6]||(e[6]=[s("i",{class:"las la-times"},null,-1)]),8,K)])]))),128)),a.order.instalments.length===0?(c(),h("div",Q,[s("p",W,i(a.__("There is no instalment defined. Please set how many instalments are allowed for this order")),1)])):g("",!0)])])]),s("div",X,[s("div",Z,[s("div",$,[f(m,{onClick:e[3]||(e[3]=o=>a.skipInstalments()),type:"info"},{default:b(()=>[v(i(a.__("Skip Instalments")),1)]),_:1})])]),s("div",ee,[s("div",te,[f(m,{onClick:e[4]||(e[4]=o=>a.close()),type:"error"},{default:b(()=>[v(i(a.__("Cancel")),1)]),_:1})]),s("div",se,[f(m,{onClick:e[5]||(e[5]=o=>a.updateOrder()),type:"info"},{default:b(()=>[v(i(a.__("Proceed")),1)]),_:1})])])])])}const me=j(O,[["render",ne]]);export{me as default};
